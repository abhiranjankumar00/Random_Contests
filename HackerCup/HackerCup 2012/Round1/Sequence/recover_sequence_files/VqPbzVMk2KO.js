/*1327297687,176820409*/

if (window.CavalryLogger) { CavalryLogger.start_js(["ZISMM"]); }

__d("MercuryIDs",[],function(c,e,f,d,b){function a(g){return typeof g==='string'&&g.indexOf(':')!==-1;}d.exports={isValid:function(g){if(!g)return false;return a(g);},tokenize:function(g){if(!this.isValid(g))throw 'bad_id_format';var h=g.indexOf(':');return {type:g.substr(0,h),value:g.substr(h+1)};}};});
__d("MercuryAssert",["MercuryIDs"],function(c,e,f,d,b){var a=e('MercuryIDs');d.exports={isParticipantID:function(g){if(!a.isValid(g))throw 'bad_participant_id';},allParticipantIDs:function(g){g.forEach(this.isParticipantID);},isUserParticipantID:function(g){var h=a.tokenize(g);if(h.type!='fbid')throw 'bad_user_id';},isEmailParticipantID:function(g){var h=a.tokenize(g);if(h.type!='email')throw 'bad_email_id';},allThreadID:function(g){g.forEach(this.isThreadID);},isThreadID:function(g){if(!a.isValid(g))throw 'bad_thread_id';}};});
__d("CallbackManager",["copyProperties"],function(d,f,g,e,c){var b=f('copyProperties');var a=function(){this._pending=[];this._resources={};};a.prototype={executeOrEnqueue:function(l,h){var i=h;var k=l;if(!(l instanceof Array)){k=[k];i=function(m){h(m[l]);};}var j=this._attemptCallback(i,k);if(j)return [];this._pending.push({fn:i,resources:k});return this._getUnavailableResources(k);},addResourcesAndExecute:function(h){b(this._resources,h);this._runPossibleCallbacks();},setResource:function(h,i){this._resources[h]=i;this._runPossibleCallbacks();},getResource:function(h){return this._resources[h];},dumpResources:function(){var h={};for(var i in this._resources){var j=this._resources[i];if(typeof j==='object')j=b({},j);h[i]=j;}return h;},_runPossibleCallbacks:function(){var h=this._pending;this._pending=[];var i=[];h.forEach(function(j){if(this._constructCallbackArg(j.resources,true)){i.push(j);}else this._pending.push(j);}.bind(this));i.forEach(function(j){this._attemptCallback(j.fn,j.resources);}.bind(this));},_attemptCallback:function(i,j){var h=this._constructCallbackArg(j,true);h&&i(h);return !!h;},_constructCallbackArg:function(l,h){var m={};for(var i=0;i<l.length;i++){var j=l[i];var k=this._resources[j];if(typeof k=='undefined'&&h)return false;m[j]=k;}return m;},_getUnavailableResources:function(h){return h.filter(function(i){return !this._resources[i];}.bind(this));}};e.exports=a;});
__d("TimestampConverter",["JSLogger"],function(f,h,i,g,e){var a=h('JSLogger');var d=a.create('timestamp_converter');function c(j){return (typeof(j)=='string')&&j.length>6;}var b={convertActionIDToTimestamp:function(j){if(c(j)){var k=j.slice(0,-6);return parseInt(k,10);}},maxValidActionID:function(j,k){if(!c(j))return k;if(!c(k))return j;return this.isGreaterThan(j,k)?j:k;},isGreaterThan:function(j,k){if(!c(j)||!c(k))return false;return this.convertActionIDToTimestamp(j)>this.convertActionIDToTimestamp(k);}};g.exports=b;});
__d("MercuryServerDispatcher",["copyProperties","AsyncRequest","FunctionUtils","URI","Dialog"],function(i,k,l,j,h){var g=k('copyProperties');var a=k('AsyncRequest');var c=k('FunctionUtils');var e=k('URI');var f={};var d={IMMEDIATE:'immediate',IDEMPOTENT:'idempotent',BATCH_SUCCESSIVE:'batch-successive',BATCH_DEFERRED_MULTI:'batch-deferred-multi',registerEndpoints:function(m){for(var o in m){var n=m[o];f[o]=new b(o,n);}},trySend:function(n,m){f[n].trySend(m);}};function b(o,n){var m=n.mode||d.IMMEDIATE;switch(m){case d.IMMEDIATE:case d.IDEMPOTENT:case d.BATCH_SUCCESSIVE:case d.BATCH_DEFERRED_MULTI:break;default:throw new Error('Invalid MercuryServerDispatcher mode '+m);}this._endpoint=o;this._mode=m;this._combineData=n.batch_function;this._handler=n.handler;this._errorHandler=n.error_handler;this._deferredSend=c.debounce(this._batchSend.bind(this),0,false);}b.prototype={_inFlight:0,_handler:null,_errorHandler:null,_combineData:null,trySend:function(m){if(typeof m=='undefined')m=null;var n=this._mode;if(n==d.IMMEDIATE){this._send(m);}else if(n==d.IDEMPOTENT){if(!this._inFlight)this._send(m);}else if(n==d.BATCH_SUCCESSIVE){if(!this._inFlight){this._send(m);}else this._batchData(m);}else if(n==d.BATCH_DEFERRED_MULTI){this._batchData(m);this._deferredSend();}},_send:function(m){this._inFlight++;new a(this._endpoint).setData(m).setHandler(this._handleResponse.bind(this)).setErrorHandler(this._handleError.bind(this)).setTransportErrorHandler(this._handleError.bind(this)).send();},_batchData:function(m){if(typeof this._batchedData=='undefined'){this._batchedData=m;}else this._batchedData=this._combineData(this._batchedData,m);},_batchSend:function(){if(typeof this._batchedData!='undefined'){this._send(this._batchedData);delete this._batchedData;}},_handleResponse:function(n){this._inFlight--;var m=n.getPayload();if(m&&m.error_payload){if(this._errorHandler)this._errorHandler(n);}else this._handler&&this._handler(m);if(this._mode==d.BATCH_SUCCESSIVE)this._batchSend();},_handleError:function(m){this._errorHandler&&this._errorHandler(m);this._inFlight--;}};j.exports=d;});
__d("MercuryThreadInformer",["Arbiter","copyProperties","MercuryAssert"],function(m,o,p,n,l){var a=o('Arbiter');var k=o('copyProperties');var b=o('MercuryAssert');var f={};var g=false;var j=false;var i=false;var e={};var d=0;function h(){if(!d)try{var changed_threads=keys(f);if(changed_threads.length||g)c.inform('threadlist-updated',changed_threads);if(changed_threads.length)c.inform('threads-updated',f);if(j)c.inform('unseen-updated',null);if(i)c.inform('unread-updated',null);var received_message_threads=keys(e);if(received_message_threads.length)c.inform('messages-received',e);}catch(q){throw q;}finally{f={};g=false;j=false;e={};}}var c=k(new a(),{updatedThread:function(q){f[q]=true;h();},updatedThreadlist:function(){g=true;h();},updatedUnseenState:function(){j=true;h();},updatedUnreadState:function(){i=true;h();},receivedMessage:function(q){b.isThreadID(q.thread_id);var r=q.thread_id;if(!e[r])e[r]=[];e[r].push(q);this.updatedThread(r);},synchronizeInforms:function(q){d++;try{q();}catch(r){throw r;}finally{d--;h();}},listen:function(r,q){return this.subscribe('threads-updated',function(t,s){if(s[r])q(r);});}});n.exports=c;});
__d("MercuryServerRequests",["Arbiter","CallbackManager","TimestampConverter","copyProperties","Env","JSLogger","MercuryAssert","ObjectUtils","MercuryServerDispatcher","MercuryThreadInformer","MercuryIDs","hasArrayNature","MercuryConstants"],function(ze,zh,zi,zg,zd){var a=zh('Arbiter');var b=zh('CallbackManager');var d=zh('TimestampConverter');var zb=zh('copyProperties');var e=zh('Env');var f=zh('JSLogger');var g=zh('MercuryAssert');var i=zh('ObjectUtils');var j=zh('MercuryServerDispatcher');var l=zh('MercuryThreadInformer');var h=zh('MercuryIDs');var zf=zh('hasArrayNature');var c=zh('MercuryConstants');var u=0;var t=f.create('mercury_server');var x=new b();var n=new b();var z=[];var p={};var v={};function za(zj){u=d.maxValidActionID(u,zj);}function o(zm){var zl=zm.thread_id;var zj=x.getResource(zl);if(!zj){if(zm.is_canonical_user){var zk=zm.participants;if(zk.length==1){zj='user:'+e.user;}else zk.forEach(function(zo){var zn=h.tokenize(zo);if(zn.type=='fbid'&&zn.value!=e.user)zj='user:'+zn.value;});}else if(zm.is_canonical_group){zj='group:'+zm.group_id;}else if(zm.root_message_threading_id)zj='root:'+zm.root_message_threading_id;zj=zj||'thread:'+zl;y(zl,zj);}zm.thread_id=zj;}function y(zk,zj){x.setResource(zk,zj);n.setResource(zj,zk);v[zk]=zj;}function r(zm,zj){var zl=n.executeOrEnqueue(zm,zj);var zk=k.tokenizeThreadID(zm);if(zl.length&&zk.type!='root')k.fetchThreadData(zl);}function s(zj){return n.getResource(zj);}function q(zk){var zj=x.getResource(zk);if(typeof zj=='undefined')t.warn('no_client_thread_id',{server_id:zk});return zj;}function w(zj){(zj.threads||[]).forEach(function(zk){o(zk);delete p[zk.thread_id];za(zk.last_action_id);});(zj.ordered_threadlists||[]).forEach(function(zk){zk.thread_ids=zk.thread_ids.map(q);});if(z.length){zj.actions=z.concat(zj.actions?zj.actions:[]);z=[];}zj.actions=zj.actions||[];zj.actions.forEach(function(zk){if(zk.status&&zk.status!=c.MercuryActionStatus.SUCCESS&&!zk.thread_id){zk.thread_id=zk.client_thread_id;return;}if(zk.action_type==c.MercuryActionType.SEND_MESSAGE&&zk.client_thread_id)y(zk.thread_id,zk.client_thread_id);zk.thread_id=q(zk.thread_id);za(zk.action_id);});}function m(zl,zj){var zm=zb({},zl);for(var zk in zj)if(zf(zm[zk])){zm[zk]=keys(i.createFrom(zm[zk].concat(zj[zk])));}else if(zm[zk]){zm[zk]=zb(zm[zk],zj[zk]);}else zm[zk]=zj[zk];return zm;}var k=zb(new a(),{tokenizeThreadID:function(zj){g.isThreadID(zj);return h.tokenize(zj);},getServerThreadID:function(zk,zj){g.isThreadID(zk);r(zk,zj);},getClientThreadIDNow:function(zj){return x.getResource(zj);},convertThreadIDIfAvailable:function(zk){var zj=x.getResource(zk);if(zj===undefined){return zk;}else return zj;},canLinkExternally:function(zj){g.isThreadID(zj);var zk=k.tokenizeThreadID(zj);return (zk.type=='user')||!!s(zj);},fetchMissedMessages:function(){j.trySend('/mercury/ajax/thread_sync.php',{last_action_id:u});},fetchThreadData:function(zm){g.allThreadID(zm);var zk={};var zo=[];var zn=[];var zl=[];zm.forEach(function(zq){if(p[zq])return;p[zq]=true;var zp=k.tokenizeThreadID(zq);if(zp.type=='user'){zo.push(zp.value);zk.users=zo;}else if(zp.type=='group'){zl.push(zp.value);zk.groups=zl;}else if(zp.type=='thread'){zn.push(zp.value);zk.threads=zn;}else if(zp.type!='root')throw new Error('Unknown thread type',zp);});for(var zj in zk){j.trySend('/mercury/ajax/thread_info.php',zk);break;}},ensureThreadIsFetched:function(zj){if(!x.getResource(zj))j.trySend('/mercury/ajax/thread_info.php',{threads:[zj]});},fetchThreadMessages:function(zk,zj){g.isThreadID(zk);r(zk,function(zm){var zl={messages:{}};zl.messages[zm]=zj;j.trySend('/mercury/ajax/thread_info.php',zl);});},handleThreadInfoError:function(zm){var zk=zm.getRequest().getData();var zj=[];if(zk.messages){var zl=zk.messages;for(var zn in zl)zj.push({action_type:c.MercuryActionType.LOG_MESSAGE,thread_id:zn,message_id:zn,timestamp:1,timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:c.MercurySourceType.UNKNOWN,log_message_type:c.MercuryLogMessageType.SERVER_ERROR,log_message_data:{}});}if(zj.length)k.handleUpdate({actions:zj,payload_source:c.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});if((zk.users||zk.groups||zk.threads)&&!zk.is_retry){if(zk.messages)delete zk.messages;zk.is_retry=true;j.trySend('/mercury/ajax/thread_info.php',zk);}},changeThreadReadStatus:function(zl,zk){g.isThreadID(zl);r(zl,function(zn){var zm={ids:{}};zm.ids[zn]=zk;j.trySend('/mercury/ajax/change_read_status.php',zm);});var zj=[{action_type:c.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:zl,mark_as_read:zk}];this.handleUpdate({actions:zj,payload_source:c.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS},true);},_batchThreadRead:function(zl,zk){var zj={};zb(zj,zl.ids);zb(zj,zk.ids);return {ids:zj};},sendNewMessage:function(zk){var zj=k.tokenizeThreadID(zk.thread_id);var zl=zb({},zk);if((zj.type=='root'&&zj.value==zl.message_id)||(zj.type=='user'&&!s(zk.thread_id))){zl.client_thread_id=zl.thread_id;zl.thread_id=null;this._sendNewMessageToServer(zl);}else r(zl.thread_id,function(zn){zl.thread_id=zn;k._sendNewMessageToServer(zl);});var zm={actions:[zb({},zk)],payload_source:c.MercuryPayloadSource.CLIENT_SEND_MESSAGE};k.handleUpdate(zm,true);},_sendNewMessageToServer:function(zj){j.trySend('/mercury/ajax/send_messages.php',{message_batch:[zj]});},_batchMessageSend:function(zk,zj){return {message_batch:zk.message_batch.concat(zj.message_batch)};},requestMessageConfirmation:function(zo){var zj={};var zm={};for(var zq in zo){var zp=s(zq);if(zp){zj[zp]=zo[zq];}else{var zn=zo[zq];for(var zk=0;zk<zn.length;zk++)zm[zn[zk]]=zq;}}var zr=i.getKeys(zj);var zl=i.getKeys(zm);if(zr.length||zl.length)j.trySend('/mercury/ajax/confirm_messages.php',{thread_message_map:zj,local_messages:zm});},handleMessageConfirmError:function(zo){var zq=zo.getRequest().getData().thread_message_map;var zl=zo.getRequest().getData().local_messages;if(!zq&&!zl)return;var zj=[];for(var zp in zq){var zn=zq[zp];zn.forEach(function(zr){zj.push({action_type:c.MercuryActionType.SEND_MESSAGE,client_message_id:zr,message_id:zr,client_thread_id:null,thread_id:zp,status:c.MercuryActionStatus.UNABLE_TO_CONFIRM});});}for(var zm in zl){var zk=zl[zm];zj.push({action_type:c.MercuryActionType.SEND_MESSAGE,client_message_id:zm,message_id:zm,client_thread_id:zk,thread_id:null,status:c.MercuryActionStatus.UNABLE_TO_CONFIRM});}if(zj.length)this.handleUpdate({actions:zj,payload_source:c.MercuryPayloadSource.CLIENT_HANDLE_ERROR});},markSeen:function(){var zj=d.convertActionIDToTimestamp(u);j.trySend('/mercury/ajax/mark_seen.php',{seen_timestamp:zj});},_batchMarkSeen:function(zk,zj){return zj;},handleUpdate:function(zl,zk){t.debug('handle_update',{payload:zl,from_client:zk});for(var zj in zl){l.synchronizeInforms(function(){if(!zk)w(zl);this.inform('update-thread-ids',v);v={};this.inform('update-unread',zl);this.inform('update-participants',zl);this.inform('update-threads',zl);this.inform('update-threadlist',zl);this.inform('update-messages',zl);this.inform('update-unseen',zl);this.inform('model-update-completed',null);}.bind(this));break;}},handleSendMessageError:function(zn){var zl=zn.getPayload();var zm=zn.getRequest().getData();var zj=zm.message_batch;if(!zj)return;var zp;if(zl&&zl.error_payload){zp=c.MercuryActionStatus.UNCONFIRMED;}else zp=c.MercuryActionStatus.REQUEST_ERROR;var zo=zj.map(function(zq){return {action_type:c.MercuryActionType.SEND_MESSAGE,client_message_id:zq.message_id,message_id:zq.message_id,client_thread_id:zq.client_thread_id,thread_id:zq.thread_id,status:zp};});var zk={actions:zo,payload_source:c.MercuryPayloadSource.CLIENT_HANDLE_ERROR};this.handleUpdate(zk);},getLastActionID:function(){return u;},receivedMessage:function(zj){var zl=x.getResource(zj.thread_id);if(zl){k.handleUpdate({actions:[zb({},zj)],payload_source:c.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});return;}var zk=x.executeOrEnqueue(zj.thread_id,function(zm){z.push(zb({},zj));});j.trySend('/mercury/ajax/thread_info.php',{threads:zk});}});var zc=k.handleUpdate.bind(k);j.registerEndpoints({'/mercury/ajax/thread_sync.php':{mode:j.IDEMPOTENT,handler:zc},'/mercury/ajax/thread_info.php':{mode:j.BATCH_DEFERRED_MULTI,batch_function:m,handler:zc,error_handler:k.handleThreadInfoError.bind(k)},'/mercury/ajax/change_read_status.php':{mode:j.BATCH_SUCCESSIVE,batch_function:k._batchThreadRead,handler:zc},'/mercury/ajax/send_messages.php':{mode:j.BATCH_SUCCESSIVE,batch_function:k._batchMessageSend,handler:zc,error_handler:k.handleSendMessageError.bind(k)},'/mercury/ajax/mark_seen.php':{mode:j.BATCH_SUCCESSIVE,batch_function:k._batchMarkSeen,handler:zc},'/mercury/ajax/confirm_messages.php':{mode:j.IMMEDIATE,handler:zc,error_handler:k.handleMessageConfirmError.bind(k)}});zg.exports=k;});
__d("MercuryRequireEnsure",[],function(b,d,e,c,a){c.exports.ensure=function(g,h,f){e(g,h,f);};});
__d("MercuryParticipants",["Env","MercuryConstants","JSLogger","MercuryAssert","ObjectUtils","ShortProfiles","MercuryServerRequests","MercuryIDs","copyProperties"],function(q,s,t,r,p){var b=s('Env');var a=s('MercuryConstants');var c=s('JSLogger');var d=s('MercuryAssert');var f=s('ObjectUtils');var i=s('ShortProfiles');var h=s('MercuryServerRequests');var e=s('MercuryIDs');var o=s('copyProperties');var n='fbid:'+b.user;var m={};var l=c.create('mercury_participants');var j=function(u){if(!m[u.id])m[u.id]=o({},u);};function k(v){d.isEmailParticipantID(v);var w=e.tokenize(v);var u=w.value;return {gender:a.MercuryParticipantsConstants.UNKNOWN_GENDER,href:null,id:v,image_src:a.MercuryParticipantsConstants.EMAIL_IMAGE,name:u,short_name:u};}var g={user:n,get:function(v,u){d.isParticipantID(v);this.getMulti([v],function(w){u(w[v]);});},getMulti:function(v,u){d.allParticipantIDs(v);var y={};var w={};v.forEach(function(za){if(m[za]){y[za]=o({},m[za]);}else{var z=e.tokenize(za);if(z.type=='fbid'){var zb=z.value;w[za]=zb;}else if(z.type=='email')y[za]=k(za);}});var x=f.getValues(w);if(x.length){i.getMulti(x,function(zc){for(var z in w){var zb=w[z];var za=zc[zb];y[z]={gender:za.gender,href:za.uri,id:z,image_src:za.thumbSrc,name:za.name,short_name:za.firstName};}u(y);});}else u(y);},getUserID:function(v){if(!e.isValid(v))return null;var u=e.tokenize(v);if(u.type!='fbid')return null;return u.value;},addParticipants:function(u){u.forEach(j);}};h.subscribe('update-participants',function(v,u){g.addParticipants(u.participants||[]);});r.exports=g;});
__d("MercuryThreads",["Arbiter","copyProperties","JSLogger","CallbackManager","TimestampConverter","MercuryAssert","MercuryServerRequests","MercuryThreadInformer","MercuryParticipants","MercuryConstants"],function(v,x,y,w,u){var a=x('Arbiter');var t=x('copyProperties');var e=x('JSLogger');var b=x('CallbackManager');var d=x('TimestampConverter');var f=x('MercuryAssert');var h=x('MercuryServerRequests');var i=x('MercuryThreadInformer');var g=x('MercuryParticipants');var c=x('MercuryConstants');var o=e.create('mercury_threads');var q=new b();function k(ze,zc,z){var zb=d.maxValidActionID(ze.action_id,z);if(!z||zb===z){var zd=Object.from(ze.participants,true);var za=g.user;zc.forEach(function(zf){if(zd[zf]!==true){ze.participants.push(zf);if(zf===za)ze.is_subscribed=true;}});}}function p(zc,zb,z){var za=d.maxValidActionID(zc.action_id,z);if(!z||za===z){zc.participants.remove(zb);if(zb===g.user)zc.is_subscribed=false;}}function l(za,z){if(za.participants[0]!=z){za.participants.remove(z);za.participants.unshift(z);}}function s(zd,za){var z=za.body;var zc=za.subject;var zb='';if(zc){zc=zc.toLowerCase();if(z.slice(0,zc.length).toLowerCase()==zc){zb=z;}else if(z){zb=zc+' \u00B7 '+z;}else zb=zc;}else zb=z;zd.snippet=zb;zd.snippet_has_attachment=za.has_attachment;zd.snippet_attachments=za.attachments;zd.is_forwarded_snippet=!!za.forward_count;}function m(zb,za){if(!zb)return false;var z=!zb.unread_count;if(!zb||za==z)return false;zb.unread_count=za?0:1;q.setResource(zb.thread_id,zb);i.updatedThread(zb.thread_id);return true;}function r(zb,z){var zc=z.action_type;if(zc==c.MercuryActionType.USER_GENERATED_MESSAGE||zc==c.MercuryActionType.LOG_MESSAGE){z.is_unread&&zb.unread_count++;zb.is_archived=false;}switch(zc){case c.MercuryActionType.USER_GENERATED_MESSAGE:l(zb,z.author);break;case c.MercuryActionType.LOG_MESSAGE:var za=z.log_message_type;if(za==c.MercuryLogMessageType.SUBSCRIBE){k(zb,z.log_message_data.added_participants,z.action_id);}else if(za==c.MercuryLogMessageType.UNSUBSCRIBE)p(zb,z.author,z.action_id);break;case c.MercuryActionType.CHANGE_READ_STATUS:m(zb,z.mark_as_read);break;}zb.last_action_id=d.maxValidActionID(z.action_id,zb.last_action_id);}function n(za){var z=h.tokenizeThreadID(za.thread_id);if(z.type=='group'){o.error('invalid_new_thread_message',za);return undefined;}var zb={thread_id:za.thread_id,last_action_id:za.action_id,participants:za.specific_to_list,name:null,snippet:za.body,snippet_has_attachment:false,snippet_attachments:[],unread_count:0,image_src:null,timestamp_absolute:za.timestamp_absolute,timestamp_relative:za.timestamp_relative,timestamp:za.timestamp,is_canonical_user:z.type=='user',is_subscribed:true,is_canonical_group:false,group_id:null,root_message_threading_id:za.message_id,folder:c.MessagingTag.INBOX,is_archived:false};q.setResource(zb.thread_id,zb);return zb;}a.subscribe(e.DUMP_EVENT,function(za,z){z.messaging=z.messaging||{};z.messaging.threads=q.dumpResources();});var j={getThreadMetaNow:function(z){f.isThreadID(z);return q.getResource(z);},getThreadMeta:function(zc,z){f.isThreadID(zc);var za=q.executeOrEnqueue(zc,z);if(!za.length)return;var zb=h.tokenizeThreadID(zc);if(zb.type=='user'){this.getCanonicalThreadToUser(zb.value);}else h.fetchThreadData(za);},changeThreadReadStatus:function(zb,z){f.isThreadID(zb);var za=q.getResource(zb);if(m(za,z))h.changeThreadReadStatus(zb,z);},updateThreads:function(za){if(!za||!za.length)return;var z={};za.forEach(function(zb){z[zb.thread_id]=zb;});q.addResourcesAndExecute(z);},updateMetadataByActions:function(za){if(!za||!za.length)return;var zi={};var zh={};var zj={};for(var zc=0;zc<za.length;zc++){var z=za[zc];var zl=z.action_type;var zk=z.thread_id;f.isThreadID(zk);var zg=this.getThreadMetaNow(zk);if(zl==c.MercuryActionType.LOG_MESSAGE&&z.log_message_type==c.MercuryLogMessageType.SERVER_ERROR)continue;if(!zg&&!z.action_id&&zl==c.MercuryActionType.USER_GENERATED_MESSAGE)zg=n(z);if(zg){if(!zj[zk])zj[zk]=t({},zg);if(z.timestamp<=zg.timestamp&&z.action_id)continue;r(zj[zk],z);if(zl==c.MercuryActionType.USER_GENERATED_MESSAGE)zi[zk]=z;if(zl==c.MercuryActionType.USER_GENERATED_MESSAGE||zl==c.MercuryActionType.LOG_MESSAGE||zl==c.MercuryActionType.SEND_MESSAGE)if(z&&(!zh[zk]||z.timestamp>zh[zk].timestamp))zh[zk]=z;}}for(var zf in zj){var zb=zj[zf];var ze=zi[zf];if(ze)s(zb,ze);var zd=zh[zf];if(zd)zb=t(zb,{timestamp_absolute:zd.timestamp_absolute,timestamp_relative:zd.timestamp_relative,timestamp:zd.timestamp});q.setResource(zf,zb);}},getCanonicalThreadToGroup:function(za,z){var zb='group:'+za;this.getThreadMeta(zb,z);},getCanonicalThreadToUser:function(zb){var za='user:'+zb;var z=q.getResource(za);if(typeof z=='undefined'){z=j.createNewLocalThread(za,[g.user,'fbid:'+zb]);h.fetchThreadData([za]);}return z;},createNewLocalThread:function(zc,za){var zb=q.getResource(zc);if(!zb){var z=h.tokenizeThreadID(zc);zb={thread_id:zc,last_action_id:null,participants:za,name:null,snippet:'',snippet_has_attachment:false,unread_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,is_canonical_user:z.type=='user',is_subscribed:true,is_canonical_group:z.type=='group',group_id:null,root_message_threading_id:null,folder:c.MessagingTag.INBOX,is_archived:false};q.setResource(zc,zb);}return zb;},addParticipantsToThreadLocally:function(zb,z){var za=q.getResource(zb);if(za){k(za,z,null);i.updatedThread(za.thread_id);}},getCanonicalUserInThread:function(za){var z=h.tokenizeThreadID(za);return z.type=='user'?z.value:null;},getCanonicalGroupInThread:function(za){var z=h.tokenizeThreadID(za);return z.type=='group'?z.value:null;},isEmptyLocalThread:function(zb){var za=q.getResource(zb);if(!za)return false;var z=h.tokenizeThreadID(zb);return z.type=='root'&&!za.timestamp;}};h.subscribe('update-threads',function(z,za){j.updateMetadataByActions(za.actions);j.updateThreads(za.threads);(za.threads||[]).each(function(zb){i.updatedThread(zb.thread_id);});});w.exports=j;});
__d("ChatTabModel",["Arbiter","ArrayUtils","copyProperties","JSLogger","math-extensions","MercuryAssert","MercuryThreads","MercuryServerRequests","PresenceState","ObjectUtils"],function(ze,zg,zh,zf,zd){var a=zg('Arbiter');var b=zg('ArrayUtils');var zc=zg('copyProperties');var c=zg('JSLogger');var d=zg('math-extensions');var e=zg('MercuryAssert');var g=zg('MercuryThreads');var f=zg('MercuryServerRequests');var i=zg('PresenceState');var h=zg('ObjectUtils');var za=[];var x=null;var o=0;var s=20;var n=c.create('chat_tab_model');var y=false;function z(zi){zi.t2=[];zi.uct2=o;zi.lm2=x;za.forEach(function(zk){if(!zk.fragile){var zj={i:zk.id,si:zk.server_id};if(zk.raised)zj.r=1;zi.t2.push(zj);}});return zi;}function p(zj){if(zj&&zj.t2){var zk=d.verifyNumber(zj.uct2);if(zk>o){o=zk;n.log('load_cookie_tabs',{tabs:zj.t2,promoted:zj.lm2});var zi=zj.t2;q(zi,zj.lm2||null);}}}function q(zj,zi){if(zb(zj,zi)){za=zj.map(function(zl){var zk={id:zl.i,server_id:zl.si};if(zl.r)zk.raised=true;if(zk.id==zi)x=zk.id;return zk;});l();t();}}function zb(zl,zk){if(zk!=x)return true;if(zl.length!=za.length)return true;for(var zi=0,zj=zl.length;zi<zj;zi++)if(!h.areEqual(zl[zi],za[zi]))return true;return false;}function t(){if(y)ChatTabModel.inform('chat/tabs-changed',ChatTabModel.get());}function k(){o=Math.floor(Date.now()*.001);i.doSync();t();}function l(){var zi=za.length-s;if(zi>0)za=za.filter(function(zj){return zj.raised||zi--<=0;});}function m(zj){for(var zi=0;zi<za.length;zi++)if(za[zi].id==zj)return zi;return -1;}function w(zj){var zk=g.getThreadMetaNow(zj);if(!zk)return false;if(zk.is_canonical_user||zk.is_canonical_group){return v(zj);}else{var zi=u(zj);if(zi)f.getServerThreadID(zj,function(zl){if(r(zj,zl))k();});return zi;}}function u(zi){if(m(zi)===-1){za.push({id:zi,fragile:true});return true;}return false;}function v(zj){var zk=m(zj);if(zk!=-1)if(za[zk].fragile){za.splice(zk,1);}else return false;for(var zi=0;zi<=za.length;zi++)if(zi==za.length||za[zi].fragile){za.splice(zi,0,{id:zj});l();return true;}}function r(zi,zk){var zj=m(zi);if(zj!=-1&&za[zj].fragile){za[zj].fragile=false;za[zj].server_id=zk;return true;}return false;}function j(zi){var zj=m(zi);if(zj!=-1){za.splice(zj,1);return true;}return false;}i.registerStateStorer(z);i.registerStateLoader(p);zf.exports=ChatTabModel=zc(new a(),{indexOf:function(zi){return m(zi);},closeAllTabs:function(){if(za.length){za=[];x=null;k();}},closeFragileTabs:function(){for(var zi=0;zi<za.length;zi++)if(za[zi].fragile){za.splice(zi);t();break;}},closeTab:function(zi){e.isThreadID(zi);if(j(zi)){if(x==zi)x=null;k();}},raiseTab:function(zj){e.isThreadID(zj);var zi=w(zj);var zk=m(zj);if(!za[zk].raised){za[zk].raised=true;k();}},get:function(){var zi=za.map(function(zj){var zk=zc({},zj);delete zk.fragile;return zk;});return {tabs:zi,promoted:x};},openFragileTab:function(zi){e.isThreadID(zi);if(u(zi))t();},openTab:function(zi){e.isThreadID(zi);if(w(zi))k();},lowerTab:function(zi){e.isThreadID(zi);var zj=m(zi);if(zj!=-1&&za[zj].raised){delete za[zj].raised;k();}},raiseAndPromoteTab:function(zi){e.isThreadID(zi);w(zi);var zj=m(zi);if(!za[zj].raised||x!=zi){za[zj].raised=true;x=zi;k();}}});a.subscribe(c.DUMP_EVENT,function(zj,zi){zi.chat_tabs={promoted:x,tabs:za.map(function(zk){return zc({},zk);}),time:o};});p(i.getInitial(),true);y=true;});
__d("ChatController",["ChatTabModel","MercuryThreads"],function(d,f,g,e,c){var a=f('ChatTabModel');var b=f('MercuryThreads');e.exports={raiseFragileGroupTab:function(h){b.getCanonicalThreadToGroup(h,function(i){a.openFragileTab(i.thread_id);});},raiseGroupTab:function(h){b.getCanonicalThreadToGroup(h,function(i){a.raiseTab(i.thread_id);});}};});
__d("ChatInterfaces",["Arbiter","AvailableList","AvailableListConstants","copyProperties","MercuryConstants"],function(j,l,m,k,i){var a=l('Arbiter');var b=l('AvailableList');var c=l('AvailableListConstants');var h=l('copyProperties');var e=l('MercuryConstants');var f=b.getInterfaces();function g(n){return n[e.MercurySourceType.CHAT_JABBER]===c.ACTIVE;}var d=h(new a(),{JABBER_CHANGED:'JABBER_CHANGED',isJabberConnected:function(){return g(f);}});b.subscribe(c.ON_INTERFACES_CHANGED,function(n,o){var q=d.isJabberConnected();var p=g(o);f=h({},o);if(q!=p)d.inform(d.JABBER_CHANGED);});k.exports=d;});